ç¬¬ä¸€æ­¥ï¼šå»ºç«‹ Webhook æ¥æ”¶äº‹ä»¶ï¼Œä¸¦æ ¹æ“š LINE userId åˆ¤æ–·æœƒå“¡èº«åˆ†
âœ… ç›®æ¨™ï¼š
ç•¶ä½¿ç”¨è€…å‚³è¨Šæ¯æ™‚ï¼ŒLINE Bot è¦èƒ½ï¼š

æ“·å– userId

æŸ¥è³‡æ–™åº«æ˜¯å¦ç‚ºæœƒå“¡

è‹¥ä¸æ˜¯ï¼Œå‚³é€è¨»å†Šè¡¨é€£çµ

ğŸ§± æ­¥é©Ÿä¸€ï¼šä¿®æ”¹ src/routes/line.tsï¼ˆæˆ–ä½ çš„ Webhook è™•ç†æª”æ¡ˆï¼‰
è«‹å…ˆç¢ºèªä½ çš„ line.ts æª”æ¡ˆå¤§è‡´çµæ§‹å¦‚ä¸‹ï¼ˆæˆ‘æä¾›ä¸€å€‹åŸºæœ¬ç¯„æœ¬ï¼‰ï¼š

ts
è¤‡è£½
ç·¨è¼¯
import express from 'express';
import { middleware, Client, WebhookEvent } from '@line/bot-sdk';
import { Member } from '../models/member';
import lineConfig from '../config/line';

const router = express.Router();
const client = new Client(lineConfig);

// LINE Webhook endpoint
router.post('/webhook', middleware(lineConfig), async (req, res) => {
  const events = req.body.events;

  for (const event of events) {
    if (event.type === 'message' && event.message.type === 'text') {
      const lineUserId = event.source.userId;

      const member = await Member.findOne({ where: { line_user_id: lineUserId } });

      if (member) {
        // âœ… å·²è¨»å†Šæœƒå“¡
        await client.replyMessage(event.replyToken, {
          type: 'text',
          text: `ğŸ‘‹ æ­¡è¿å›ä¾†ï¼Œ${member.name}ï¼`,
        });
      } else {
        // âŒ å°šæœªè¨»å†Š
        await client.replyMessage(event.replyToken, {
          type: 'flex',
          altText: 'è«‹è¨»å†Šæœƒå“¡',
          contents: {
            type: 'bubble',
            body: {
              type: 'box',
              layout: 'vertical',
              contents: [
                { type: 'text', text: 'å°šæœªè¨»å†Šæœƒå“¡', weight: 'bold', size: 'lg' },
                { type: 'text', text: 'è«‹é»æ“Šä¸‹æ–¹æŒ‰éˆ•å¡«å¯«è¨»å†Šè³‡æ–™', size: 'sm', color: '#888' }
              ],
            },
            footer: {
              type: 'box',
              layout: 'vertical',
              contents: [
                {
                  type: 'button',
                  action: {
                    type: 'uri',
                    label: 'å‰å¾€è¨»å†Š',
                    uri: 'https://liff.line.me/2007739371-aKePV20'
                  },
                  style: 'primary'
                }
              ]
            }
          }
        });
      }
    }
  }

  res.status(200).send('OK');
});

export default router;
âœ… æª¢æŸ¥äº‹é …ï¼š
 ä½ æœ‰æ²’æœ‰ä¸€å€‹ /webhook è·¯ç”±åœ¨è·‘ï¼Ÿ

 æœ‰è¼‰å…¥ @line/bot-sdk çš„ middlewareï¼Ÿ

 Member model å·²æ­£ç¢º importï¼Ÿ

 line_user_id åœ¨ DB æ˜¯å”¯ä¸€å°æ‡‰æ¬„ä½ï¼Ÿ

