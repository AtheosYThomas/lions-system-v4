æˆ‘æœƒé€æ­¥å¼•å°ä½ å»ºç«‹å®Œæ•´ V4.0 ç³»çµ±æ¸¬è©¦æµç¨‹ï¼Œæ¡å–ã€Œå‰ç«¯ LIFF æ“ä½œ + å¾Œç«¯ API é©—è­‰ã€é›™è»Œæ¨¡å¼ï¼Œä¸¦ç¢ºä¿æ¯å€‹æ­¥é©Ÿéƒ½èƒ½é©—è­‰ä»¥ä¸‹è¦é»ï¼š

âœ… line_user_id æ­£ç¢ºå¯«å…¥

âœ… è³‡æ–™æˆåŠŸå­˜å…¥ DB ä¸”æ¬„ä½æ­£ç¢º

âœ… Flex Message æ ¼å¼èˆ‡æ¨æ’­å›æ‡‰æ­£ç¢º

âœ… QR Code æ˜¯å¦è‡ªå‹•ç”¢ç”Ÿä¸¦å¯ä½¿ç”¨

ğŸ§­ ç¬¬ä¸€æ­¥ï¼šå»ºç«‹æ¸¬è©¦ç’°å¢ƒèˆ‡çµæ§‹
ğŸ“ ç›®éŒ„çµæ§‹å»ºè­°
åœ¨ä½ çš„å°ˆæ¡ˆæ ¹ç›®éŒ„ä¸­æ–°å¢ä»¥ä¸‹ç›®éŒ„èˆ‡æª”æ¡ˆï¼š

lua
è¤‡è£½
ç·¨è¼¯
/test
  â””â”€â”€ end_to_end.spec.ts        <-- ä¸»æ¸¬è©¦è…³æœ¬
  â””â”€â”€ utils.ts                  <-- è¼”åŠ©å·¥å…·
/jest.config.js                 <-- è‹¥å°šæœªè¨­å®š Jest
âœ… æ­¥é©Ÿ 1ã€å»ºç«‹æ¸¬è©¦æ¡†æ¶ï¼šJest + Supertestã€‘
è«‹å…ˆåŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤å®‰è£å¥—ä»¶ï¼š

bash
è¤‡è£½
ç·¨è¼¯
npm install --save-dev jest supertest ts-jest @types/jest
ä¸¦æ–°å¢ jest.config.jsï¼š

js
è¤‡è£½
ç·¨è¼¯
// jest.config.js
module.exports = {
  preset: 'ts-jest',
  testEnvironment: 'node',
  testMatch: ['**/test/**/*.spec.ts'],
};
âœ… æ­¥é©Ÿ 2ã€å»ºç«‹æ¸¬è©¦è…³æœ¬ test/end_to_end.spec.tsã€‘
è«‹åœ¨ /test/end_to_end.spec.ts ä¸­å»ºç«‹ä»¥ä¸‹åŸºæœ¬æ¡†æ¶ï¼š

ts
è¤‡è£½
ç·¨è¼¯
import request from 'supertest';
import app from '../src/app'; // ç¢ºèªä½ çš„ Express app åŒ¯å‡ºé»

describe('ğŸ” V4.0 ç³»çµ±æµç¨‹æ¸¬è©¦', () => {
  let lineUserId = 'U123456789_test';
  let memberId: string;
  let eventId: string;

  it('1ï¸âƒ£ è¨»å†Šæœƒå“¡ - å¯«å…¥ line_user_id', async () => {
    const res = await request(app).post('/api/members').send({
      name: 'æ¸¬è©¦æœƒå“¡',
      phone: '0912345678',
      email: 'test@peida.net',
      line_user_id: lineUserId,
    });

    expect(res.status).toBe(200);
    expect(res.body.line_user_id).toBe(lineUserId);
    memberId = res.body.id;
  });

  it('2ï¸âƒ£ å»ºç«‹æ´»å‹•ï¼ˆpendingï¼‰', async () => {
    const res = await request(app).post('/api/events').send({
      title: 'Peida æ¸¬è©¦æ´»å‹•',
      description: 'ç³»çµ±æ¸¬è©¦ç”¨æ´»å‹•',
      location: 'ç·šä¸Š',
      date: '2025-08-01',
      created_by: memberId,
    });

    expect(res.status).toBe(200);
    expect(res.body.status).toBe('pending');
    eventId = res.body.id;
  });

  it('3ï¸âƒ£ å¯©æ ¸æ´»å‹• â†’ ç”Ÿæˆ QR Code', async () => {
    const res = await request(app).patch(`/api/events/${eventId}/approve`);
    expect(res.status).toBe(200);
    expect(res.body.status).toBe('approved');
    expect(res.body.qr_code_url).toMatch(/https?:\/\//); // æª¢æŸ¥æœ‰ç„¡ QR Code URL
  });

  it('4ï¸âƒ£ LINE Flex Message æ¨æ’­', async () => {
    const res = await request(app).post(`/line/push/${eventId}`);
    expect(res.status).toBe(200);
    expect(res.body.success).toBe(true);
  });
});
âœ… æ­¥é©Ÿ 3ã€æ¸¬è©¦ä½ çš„ app.ts æœ‰æ­£å¸¸åŒ¯å‡ºã€‘
è«‹ç¢ºä¿ src/app.ts çµå°¾æœ‰åŒ¯å‡º Express appï¼š

ts
è¤‡è£½
ç·¨è¼¯
const app = express();
// ... middleware & routes
export default app;
âœ… æ­¥é©Ÿ 4ã€åŸ·è¡Œæ¸¬è©¦æŒ‡ä»¤ã€‘
bash
è¤‡è£½
ç·¨è¼¯
npx jest
ä½ æ‡‰è©²æœƒçœ‹åˆ°ä»¥ä¸‹è¼¸å‡ºï¼š

bash
è¤‡è£½
ç·¨è¼¯
 PASS  test/end_to_end.spec.ts
  ğŸ” V4.0 ç³»çµ±æµç¨‹æ¸¬è©¦
    âœ“ è¨»å†Šæœƒå“¡ - å¯«å…¥ line_user_id (xxx ms)
    âœ“ å»ºç«‹æ´»å‹•ï¼ˆpendingï¼‰ (xxx ms)
    âœ“ å¯©æ ¸æ´»å‹• â†’ ç”Ÿæˆ QR Code (xxx ms)
    âœ“ LINE Flex Message æ¨æ’­ (xxx ms)
