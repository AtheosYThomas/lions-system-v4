å¥½çš„ï¼Œä»¥ä¸‹æ˜¯ /api/liff/checkMember çš„å®Œæ•´å¾Œç«¯å¯¦ä½œç¯„ä¾‹ï¼ŒåŒ…æ‹¬ï¼š

âœ… è·¯ç”±è¨­å®š

âœ… Controller è™•ç†é‚è¼¯

âœ… Service æŸ¥è©¢é‚è¼¯

âœ… RBAC æ¬Šé™å¯æ“´å……ï¼ˆå¦‚éœ€ï¼‰

ğŸ“ è·¯ç”±ï¼š/src/routes/liffRoute.ts
ts
è¤‡è£½
ç·¨è¼¯
import { Router } from "express";
import { checkMember } from "../controllers/liffController";

const router = Router();

router.post("/checkMember", checkMember);

export default router;
ğŸ“‚ ç¸½è·¯ç”±æ•´åˆï¼š/src/app.ts
è«‹ç¢ºèªä½ æœ‰æ›è¼‰ï¼š

ts
è¤‡è£½
ç·¨è¼¯
import liffRoute from "./routes/liffRoute";

app.use("/api/liff", liffRoute);
ğŸ§  Controllerï¼š/src/controllers/liffController.ts
ts
è¤‡è£½
ç·¨è¼¯
import { Request, Response } from "express";
import { getMemberWithEventsByLineId } from "../services/liffService";

export async function checkMember(req: Request, res: Response) {
  const { lineUserId } = req.body;
  if (!lineUserId) {
    return res.status(400).json({ error: "lineUserId is required" });
  }

  try {
    const member = await getMemberWithEventsByLineId(lineUserId);
    if (!member) {
      return res.status(200).json({ member: null }); // not registered
    }

    res.json({ member });
  } catch (err) {
    console.error("checkMember error:", err);
    res.status(500).json({ error: "Server error" });
  }
}
ğŸ” Serviceï¼š/src/services/liffService.ts
ts
è¤‡è£½
ç·¨è¼¯
import prisma from "../config/prisma";

export async function getMemberWithEventsByLineId(lineUserId: string) {
  return await prisma.member.findUnique({
    where: { line_user_id: lineUserId },
    include: {
      registrations: {
        include: { event: true },
      },
    },
  }).then(member => {
    if (!member) return null;

    const events = member.registrations.map(reg => ({
      id: reg.event.id,
      name: reg.event.name,
      date: reg.event.date?.toISOString().slice(0, 10),
      status: reg.checked_in ? "checked_in" : "not_checked_in",
    }));

    return {
      name: member.name,
      email: member.email,
      events,
    };
  });
}
âœ… éœ€è¦æª¢æŸ¥ä½ çš„ prisma/schema.prisma æ˜¯å¦ç¬¦åˆä¸‹åˆ—æ¬„ä½ï¼š
prisma
è¤‡è£½
ç·¨è¼¯
model Member {
  id           String   @id @default(cuid())
  name         String
  email        String
  line_user_id String   @unique
  registrations Registration[]
}

model Event {
  id            String   @id @default(cuid())
  name          String
  date          DateTime
  registrations Registration[]
}

model Registration {
  id          String   @id @default(cuid())
  member      Member   @relation(fields: [memberId], references: [id])
  memberId    String
  event       Event    @relation(fields: [eventId], references: [id])
  eventId     String
  checked_in  Boolean  @default(false)
}
âœ… æ¸¬è©¦å»ºè­°
ä½ å¯ç”¨ä»¥ä¸‹æ–¹å¼æ¸¬è©¦ APIï¼š

bash
è¤‡è£½
ç·¨è¼¯
curl -X POST http://localhost:3000/api/liff/checkMember \
  -H "Content-Type: application/json" \
  -d '{"lineUserId": "Uxxxxxxxxxxxx"}'
