æˆ‘å€‘ä¾†å¯¦ä½œ æ­¥é©Ÿ 2ï¸âƒ£ï¼šå»ºç«‹ /admin/event/:id/push-history é é¢ï¼ŒåŒ…å«ï¼š

ğŸ“‹ æ¨æ’­ç´€éŒ„è¡¨æ ¼

ğŸ“Š æˆåŠŸï¼å¤±æ•—æ¯”ä¾‹çµ±è¨ˆåœ–ï¼ˆä½¿ç”¨ Rechartsï¼‰

ğŸ“¤ é‡å°å¤±æ•—åå–®æä¾›ã€Œé‡æ¨ã€åŠŸèƒ½

âœ… 1ï¸âƒ£ é é¢è·¯å¾‘ /admin/event/[id]/push-history.tsx
tsx
è¤‡è£½
ç·¨è¼¯
import { useRouter } from 'next/router';
import { useEffect, useState } from 'react';
import {
  PieChart, Pie, Cell, Tooltip, ResponsiveContainer,
} from 'recharts';

interface PushRecord {
  id: string;
  member: { name: string; phone: string };
  status: 'success' | 'fail';
  pushedAt: string;
}

const COLORS = ['#22c55e', '#ef4444'];

const PushHistoryPage = () => {
  const router = useRouter();
  const { id: eventId } = router.query;
  const [records, setRecords] = useState<PushRecord[]>([]);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!eventId || Array.isArray(eventId)) return;

    const fetchRecords = async () => {
      setLoading(true);
      const res = await fetch(`/api/admin/push-records?eventId=${eventId}`);
      const data = await res.json();
      setRecords(data);
      setLoading(false);
    };

    fetchRecords();
  }, [eventId]);

  const grouped = records.reduce(
    (acc, r) => {
      acc[r.status === 'success' ? 0 : 1]++;
      return acc;
    },
    [0, 0]
  );

  const failed = records.filter(r => r.status === 'fail');

  const handleRetry = async () => {
    const ids = failed.map(f => f.id);
    const res = await fetch('/api/admin/push/resend', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ pushRecordIds: ids }),
    });
    if (res.ok) {
      alert('å·²é‡ç™¼æ¨æ’­');
      window.location.reload();
    } else {
      alert('é‡æ¨å¤±æ•—');
    }
  };

  return (
    <div className="max-w-6xl mx-auto px-4 py-6">
      <h1 className="text-2xl font-bold mb-4">ğŸ“¨ æ¨æ’­ç´€éŒ„åˆ†æ</h1>

      <div className="mb-6 h-64">
        <h2 className="text-lg font-semibold mb-2">æ¨æ’­æˆåŠŸï¼å¤±æ•—æ¯”ä¾‹</h2>
        <ResponsiveContainer width="100%" height="100%">
          <PieChart>
            <Pie
              data={[
                { name: 'æˆåŠŸ', value: grouped[0] },
                { name: 'å¤±æ•—', value: grouped[1] },
              ]}
              dataKey="value"
              nameKey="name"
              outerRadius={80}
              label
            >
              {COLORS.map((color, index) => (
                <Cell key={index} fill={color} />
              ))}
            </Pie>
            <Tooltip />
          </PieChart>
        </ResponsiveContainer>
      </div>

      <div className="mb-4 flex justify-between items-center">
        <h2 className="text-lg font-semibold">è©³ç´°ç´€éŒ„</h2>
        {failed.length > 0 && (
          <button
            onClick={handleRetry}
            className="bg-red-500 text-white px-4 py-2 rounded"
          >
            ğŸ“¤ å°å¤±æ•—åå–®é‡æ¨ ({failed.length})
          </button>
        )}
      </div>

      <table className="w-full text-sm border-collapse">
        <thead>
          <tr className="bg-gray-100">
            <th className="border px-2 py-1">æœƒå“¡</th>
            <th className="border px-2 py-1">æ‰‹æ©Ÿ</th>
            <th className="border px-2 py-1">ç‹€æ…‹</th>
            <th className="border px-2 py-1">æ™‚é–“</th>
          </tr>
        </thead>
        <tbody>
          {records.map(r => (
            <tr key={r.id}>
              <td className="border px-2 py-1">{r.member.name}</td>
              <td className="border px-2 py-1">{r.member.phone}</td>
              <td className={`border px-2 py-1 ${r.status === 'fail' ? 'text-red-500' : 'text-green-600'}`}>
                {r.status}
              </td>
              <td className="border px-2 py-1">{new Date(r.pushedAt).toLocaleString()}</td>
            </tr>
          ))}
        </tbody>
      </table>
    </div>
  );
};

export default PushHistoryPage;
âœ… 2ï¸âƒ£ å»ºç«‹ API /api/admin/push/resend.ts
ts
è¤‡è£½
ç·¨è¼¯
import { prisma } from '@/lib/prisma';
import { lineClient } from '@/lib/line/client';
import { createCheckinFlexMessage } from '@/lib/line/flexTemplates';

export default async function handler(req, res) {
  if (req.method !== 'POST') return res.status(405).end();

  const { pushRecordIds } = req.body;
  if (!Array.isArray(pushRecordIds) || pushRecordIds.length === 0)
    return res.status(400).json({ error: 'ç„¡æ•ˆåƒæ•¸' });

  const records = await prisma.pushRecord.findMany({
    where: { id: { in: pushRecordIds } },
    include: {
      member: true,
      event: true,
    },
  });

  const tasks = records.map(async (r) => {
    const message = createCheckinFlexMessage(
      r.event.title,
      r.event.date.toISOString().slice(0, 10),
      r.eventId
    );

    try {
      await lineClient.pushMessage(r.member.line_user_id, message);
      await prisma.pushRecord.update({
        where: { id: r.id },
        data: { status: 'success', pushedAt: new Date() },
      });
    } catch {
      await prisma.pushRecord.update({
        where: { id: r.id },
        data: { status: 'fail', pushedAt: new Date() },
      });
    }
  });

  await Promise.allSettled(tasks);
  res.status(200).json({ success: true });
}
âœ… 3ï¸âƒ£ /admin/events å¢åŠ ã€Œæ¨æ’­æ­·å²ã€æŒ‰éˆ•
tsx
è¤‡è£½
ç·¨è¼¯
<Link href={`/admin/event/${e.id}/push-history`} className="text-sm text-gray-600 underline">
  ğŸ§¾ æ¨æ’­æ­·å²
</Link>
âœ… å®Œæ•´æˆæ•ˆï¼š
ğŸ” /admin/event/:id/push-history æ”¯æ´

æˆåŠŸ vs å¤±æ•—æ¯”

åˆ—è¡¨é¡¯ç¤ºæ‰€æœ‰æ¨æ’­è¨˜éŒ„

ä¸€éµé‡æ¨å¤±æ•—è€…