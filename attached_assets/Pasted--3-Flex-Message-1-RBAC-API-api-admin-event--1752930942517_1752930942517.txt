å¤ªå¥½äº†ï¼Œæˆ‘å€‘ä¾†å¯¦ä½œä¸¦æ•´åˆä»¥ä¸‹ 3 é …é—œéµåŠŸèƒ½åˆ° Flex Message æ¨æ’­æ¨¡çµ„ä¸­ï¼š

âœ… 1ï¸âƒ£ RBAC é™åˆ¶ï¼šåªæœ‰å¹¹éƒ¨èƒ½æ¨æ’­
ğŸ“¦ å¯¦ä½œæ–¹å¼ï¼š
åœ¨ API /api/admin/event/[id]/notify.ts åŠ å…¥è§’è‰²é©—è­‰ï¼š

ts
è¤‡è£½
ç·¨è¼¯
import { getSession } from 'next-auth/react';
import { Role } from '@/types/role';

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  const session = await getSession({ req });

  if (!session || !['President', 'Officer', 'Secretary'].includes(session.user.role)) {
    return res.status(403).json({ error: 'æ¬Šé™ä¸è¶³ï¼Œåƒ…é™å¹¹éƒ¨æ¨æ’­' });
  }

  // ... æ¨æ’­é‚è¼¯ç•¥ ...
}
ğŸ“Œ è‹¥æœªä½¿ç”¨ next-authï¼Œå¯æ”¹å¾ JWT / cookie / custom header ä¸­å–å‡ºè§’è‰²è³‡è¨Šé€²è¡Œé©—è­‰ã€‚

âœ… 2ï¸âƒ£ æ’ç¨‹æ¨æ’­ï¼šå ±åˆ°å‰ä¸€å¤©è‡ªå‹•æ¨æ’­
ğŸ“¦ å¯¦ä½œæ–¹æ¡ˆï¼š
ä½¿ç”¨ cron-job.org æˆ– Replit Cron è§¸ç™¼æ¯æ—¥ 00:00 å‘¼å« /api/push/checkin-reminder

å»ºç«‹ API /api/push/checkin-reminder.tsï¼š
ts
è¤‡è£½
ç·¨è¼¯
import { prisma } from '@/lib/prisma';
import { lineClient } from '@/lib/line/client';
import { createCheckinFlexMessage } from '@/lib/line/flexTemplates';
import { addDays, isSameDay } from 'date-fns';

export default async function handler(req, res) {
  const tomorrow = addDays(new Date(), 1);

  const events = await prisma.event.findMany({
    where: {
      date: {
        gte: new Date(tomorrow.setHours(0, 0, 0, 0)),
        lte: new Date(tomorrow.setHours(23, 59, 59, 999)),
      },
    },
  });

  const members = await prisma.member.findMany({
    where: { line_user_id: { not: null } },
  });

  const tasks = events.flatMap(event => {
    const msg = createCheckinFlexMessage(event.title, event.date.toISOString().slice(0, 10), event.id);

    return members.map(m =>
      lineClient.pushMessage(m.line_user_id, msg).then(() =>
        prisma.pushRecord.create({
          data: {
            memberId: m.id,
            eventId: event.id,
            messageType: 'checkin_reminder',
            status: 'success',
          }
        }).catch(() => {})
      ).catch(() =>
        prisma.pushRecord.create({
          data: {
            memberId: m.id,
            eventId: event.id,
            messageType: 'checkin_reminder',
            status: 'fail',
          }
        }).catch(() => {})
      );
    );
  });

  await Promise.allSettled(tasks);
  res.status(200).json({ success: true });
}
ğŸ“Œ å»ºè­°ä½ ä½¿ç”¨å¤–éƒ¨æœå‹™å®šæ™‚è§¸ç™¼æ­¤ APIï¼Œæ¯æ—¥å‡Œæ™¨è‡ªå‹•æƒæ + æ¨æ’­ã€‚

âœ… 3ï¸âƒ£ æ¨æ’­ç´€éŒ„è¨˜å…¥è³‡æ–™åº«
æ–°å¢ Prisma æ¨¡å‹ï¼š
prisma
è¤‡è£½
ç·¨è¼¯
model PushRecord {
  id           String   @id @default(cuid())
  member       Member   @relation(fields: [memberId], references: [id])
  memberId     String
  event        Event    @relation(fields: [eventId], references: [id])
  eventId      String
  messageType  String   // e.g. 'checkin_reminder'
  status       String   // 'success' or 'fail'
  pushedAt     DateTime @default(now())
}
bash
è¤‡è£½
ç·¨è¼¯
npx prisma migrate dev --name add_push_record