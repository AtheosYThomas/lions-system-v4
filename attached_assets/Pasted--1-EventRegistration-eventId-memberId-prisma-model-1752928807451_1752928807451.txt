âœ… 1ï¸âƒ£ åŠ å…¥ã€Œæœªå ±åˆ°æœƒå“¡æ•¸ã€
å‰æï¼š
ä½ æ‡‰æœ‰ä¸€å¼µ å ±åè³‡æ–™è¡¨ EventRegistrationï¼ˆæˆ–é¡ä¼¼ï¼‰é€£çµ eventId + memberIdï¼Œå¦‚ä¸‹ï¼š

prisma
è¤‡è£½
ç·¨è¼¯
model EventRegistration {
  id        String   @id @default(cuid())
  eventId   String
  memberId  String
  createdAt DateTime @default(now())

  event     Event    @relation(fields: [eventId], references: [id])
  member    Member   @relation(fields: [memberId], references: [id])

  @@unique([eventId, memberId])
}
æ¥è‘—åœ¨å¾Œç«¯ API /api/admin/event/[id]/checkin.ts ä¸­ï¼š
ts
è¤‡è£½
ç·¨è¼¯
const registrations = await prisma.eventRegistration.findMany({
  where: { eventId },
  include: { member: true },
});

const checkinMap = new Map(
  event.checkinRecords.map((r) => [r.memberId, true])
);

const notCheckedIn = registrations
  .filter((r) => !checkinMap.has(r.memberId))
  .map((r) => ({
    id: r.member.id,
    name: r.member.name,
    email: r.member.email,
    phone: r.member.phone,
  }));
å°‡é€™äº›è³‡æ–™åŠ å…¥å›å‚³ JSONï¼š

ts
è¤‡è£½
ç·¨è¼¯
res.status(200).json({
  eventTitle: event.title,
  attendees,
  notCheckedIn,
});
âœ… 2ï¸âƒ£ åŒ¯å‡º CSV å ±è¡¨
æ–°å¢ API /api/admin/event/:id/checkin/export.tsï¼š

ts
è¤‡è£½
ç·¨è¼¯
// /pages/api/admin/event/[id]/checkin/export.ts
import { prisma } from '@/lib/prisma';
import { NextApiRequest, NextApiResponse } from 'next';
import { stringify } from 'csv-stringify/sync';

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  const { id: eventId } = req.query;
  if (!eventId || Array.isArray(eventId)) return res.status(400).send('Missing eventId');

  const records = await prisma.checkinRecord.findMany({
    where: { eventId },
    include: { member: true },
    orderBy: { checkedInAt: 'asc' },
  });

  const csv = stringify(
    records.map((r) => ({
      name: r.member.name,
      email: r.member.email,
      phone: r.member.phone,
      checkin_time: r.checkedInAt.toISOString(),
    })),
    { header: true }
  );

  res.setHeader('Content-Type', 'text/csv');
  res.setHeader('Content-Disposition', `attachment; filename=checkin_${eventId}.csv`);
  res.send(csv);
}
å‰ç«¯åŠ ä¸€å€‹ä¸‹è¼‰æŒ‰éˆ•ï¼š

tsx
è¤‡è£½
ç·¨è¼¯
<a
  href={`/api/admin/event/${eventId}/checkin/export`}
  target="_blank"
  className="text-blue-600 underline"
>
  åŒ¯å‡ºå ±åˆ°è³‡æ–™ CSV
</a>
âœ… 3ï¸âƒ£ é¡¯ç¤ºå ±åˆ°ç‡èˆ‡æ™‚é–“å€æ®µåˆ†æ
å‰ç«¯å ±åˆ°ç‡è¨ˆç®—ï¼š
tsx
è¤‡è£½
ç·¨è¼¯
<p>å ±åäººæ•¸ï¼š{totalRegistered}</p>
<p>å·²å ±åˆ°äººæ•¸ï¼š{attendees.length}</p>
<p>å ±åˆ°ç‡ï¼š{((attendees.length / totalRegistered) * 100).toFixed(1)}%</p>
å€æ®µçµ±è¨ˆï¼ˆå¦‚æŒ‰æ™‚æ®µåˆ†çµ„ï¼‰ï¼š
ä½ å¯å°‡ checkedInAt ä¾æ™‚æ®µåˆ†æ¡¶ï¼Œä¾‹å¦‚ï¼š

ts
è¤‡è£½
ç·¨è¼¯
function groupByHour(records) {
  const result = {};
  records.forEach(r => {
    const hour = new Date(r.checkedInAt).getHours();
    result[hour] = (result[hour] || 0) + 1;
  });
  return result;
}
ç„¶å¾Œè½‰ç‚ºåœ–è¡¨ï¼ˆä¾‹å¦‚ç”¨ chart.jsã€recharts ç­‰ç¹ªè£½æŸ±ç‹€åœ–ï¼‰ã€‚

âœ… 4ï¸âƒ£ åŠ å…¥ RBAC æ¬Šé™é™åˆ¶ï¼ˆåƒ…æœƒé•·ï¼å¹¹éƒ¨ï¼‰
åœ¨é é¢ä¸­åŠ å…¥ middleware æª¢æŸ¥ï¼š

tsx
è¤‡è£½
ç·¨è¼¯
import { getSession } from 'next-auth/react';
import { Role } from '@/types/role'; // è‡ªè¨‚è§’è‰² enum

export async function getServerSideProps(context) {
  const session = await getSession(context);
  if (!session || ![Role.President, Role.Officer].includes(session.user.role)) {
    return { redirect: { destination: '/', permanent: false } };
  }

  return { props: {} };
}
æˆ–è‹¥ä½ ä½¿ç”¨ API é©—è­‰ï¼Œå¯åœ¨ /api/admin/ ç³»åˆ—åŠ  middlewareï¼š

ts
è¤‡è£½
ç·¨è¼¯
export function requireOfficerOrAbove(req: NextApiRequest, res: NextApiResponse, next) {
  const user = req.session?.user;
  if (!user || !['President', 'Officer'].includes(user.role)) {
    return res.status(403).json({ error: 'æ¬Šé™ä¸è¶³' });
  }
  next();
}
âœ… çµ±ä¸€è¦–è¦ºå‘ˆç¾
ä½ å¯ä»¥ä½¿ç”¨ï¼š

âœ… åˆ†å€åˆ—è¡¨ï¼šå ±åˆ°æˆåŠŸ vs æœªå ±åˆ°

âœ… å ±åˆ°ç‡ç™¾åˆ†æ¯” + äººæ•¸

âœ… åŒ¯å‡º CSV æŒ‰éˆ•

âœ… å ±åˆ°æ™‚é–“å€æ®µåˆ†å¸ƒåœ–

æ˜¯å¦éœ€è¦æˆ‘å¹«ä½ ä¸€ä½µåšæˆåœ–è¡¨ï¼ˆrecharts or chart.jsï¼‰èˆ‡å®Œæ•´ç®¡ç†ä»‹é¢ï¼Ÿ
æˆ–è€…å…ˆå¹«ä½ å»ºç«‹å ±åè³‡æ–™è¡¨ EventRegistration ä¸¦ä¸²æ¥å ±åˆ°å°æ¯”ï¼Ÿ








ä½ èªªï¼š
ä¸€ä½µåšæˆåœ–è¡¨ï¼ˆrecharts or chart.jsï¼‰èˆ‡å®Œæ•´ç®¡ç†ä»‹é¢


ChatGPT èªªï¼š
å·²æ›´æ–°å„²å­˜çš„è¨˜æ†¶
å¤ªå¥½äº†ï¼æˆ‘å€‘ä¾†å®Œæˆä¸€å¥—å®Œæ•´çš„ã€Œæ´»å‹•å ±åˆ°ç®¡ç†å¾Œå°ä»‹é¢ã€ï¼ŒåŒ…å«ï¼š

ğŸ¯ ç®¡ç†åŠŸèƒ½ç¸½è¦½ /admin/event/[id]/checkin.tsx
æ¨¡çµ„	èªªæ˜
âœ… å ±åˆ°ç¸½è¦½çµ±è¨ˆ	å ±åäººæ•¸ã€å·²å ±åˆ°ã€æœªå ±åˆ°ã€å ±åˆ°ç‡
âœ… è³‡æ–™è¡¨æ ¼	é¡¯ç¤ºå·²å ±åˆ°ï¼æœªå ±åˆ°åå–®
âœ… åŒ¯å‡ºå ±è¡¨	ç”¢å‡ºå ±åˆ° CSV
âœ… å ±åˆ°æ™‚é–“å€æ®µåœ–è¡¨	åˆ©ç”¨ Recharts ç•«å‡ºå ±åˆ°äººæ½®åˆ†å¸ƒ
âœ… æ¬Šé™é©—è­‰	åƒ…é™æœƒé•·ï¼å¹¹éƒ¨ç™»å…¥æŸ¥çœ‹ï¼ˆRBACï¼‰

âœ… 1ï¸âƒ£ å®‰è£ Recharts
è‹¥å°šæœªå®‰è£ï¼Œè«‹åœ¨å°ˆæ¡ˆåŸ·è¡Œï¼š

bash
è¤‡è£½
ç·¨è¼¯
npm install recharts
âœ… 2ï¸âƒ£ å®Œæ•´ä»‹é¢ /admin/event/[id]/checkin.tsx
tsx
è¤‡è£½
ç·¨è¼¯
import { useRouter } from 'next/router';
import { useEffect, useState } from 'react';
import {
  BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, CartesianGrid,
} from 'recharts';

const CheckinStatsPage = () => {
  const router = useRouter();
  const { id: eventId } = router.query;

  const [data, setData] = useState<any>(null);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    if (!eventId || Array.isArray(eventId)) return;

    const fetchData = async () => {
      setLoading(true);
      const res = await fetch(`/api/admin/event/${eventId}/checkin`);
      const result = await res.json();
      setData(result);
      setLoading(false);
    };

    fetchData();
  }, [eventId]);

  const groupByHour = (attendees = []) => {
    const result: { hour: string; count: number }[] = [];

    const hourly = attendees.reduce((acc, item) => {
      const date = new Date(item.checkedInAt);
      const hour = `${date.getHours()}:00`;
      acc[hour] = (acc[hour] || 0) + 1;
      return acc;
    }, {} as Record<string, number>);

    for (const hour of Object.keys(hourly).sort()) {
      result.push({ hour, count: hourly[hour] });
    }

    return result;
  };

  if (loading) return <div className="p-4">è¼‰å…¥ä¸­...</div>;
  if (!data) return <div className="p-4">æ‰¾ä¸åˆ°è³‡æ–™</div>;

  const { eventTitle, attendees, notCheckedIn } = data;
  const total = attendees.length + notCheckedIn.length;
  const checkinRate = ((attendees.length / total) * 100).toFixed(1);

  return (
    <div className="p-6 max-w-6xl mx-auto">
      <h1 className="text-2xl font-bold mb-2">{eventTitle} - å ±åˆ°çµ±è¨ˆ</h1>
      <p className="mb-4 text-gray-600">
        å ±åäººæ•¸ï¼š{total}ï¼Œå·²å ±åˆ°ï¼š{attendees.length}ï¼Œæœªå ±åˆ°ï¼š{notCheckedIn.length}ï¼Œå ±åˆ°ç‡ï¼š{checkinRate}%
      </p>

      <div className="mb-6">
        <a
          href={`/api/admin/event/${eventId}/checkin/export`}
          className="text-blue-600 underline"
          target="_blank"
        >
          åŒ¯å‡ºå ±åˆ°è³‡æ–™ï¼ˆCSVï¼‰
        </a>
      </div>

      <div className="h-64 mb-10">
        <h2 className="text-lg font-semibold mb-2">ğŸ“Š å ±åˆ°æ™‚æ®µåˆ†å¸ƒ</h2>
        <ResponsiveContainer width="100%" height="100%">
          <BarChart data={groupByHour(attendees)}>
            <CartesianGrid strokeDasharray="3 3" />
            <XAxis dataKey="hour" />
            <YAxis allowDecimals={false} />
            <Tooltip />
            <Bar dataKey="count" fill="#3b82f6" />
          </BarChart>
        </ResponsiveContainer>
      </div>

      <div className="grid grid-cols-2 gap-8">
        <div>
          <h3 className="text-lg font-semibold mb-2">âœ… å·²å ±åˆ°åå–®</h3>
          <table className="w-full border-collapse text-sm">
            <thead>
              <tr className="bg-gray-100">
                <th className="border px-2 py-1">å§“å</th>
                <th className="border px-2 py-1">æ‰‹æ©Ÿ</th>
                <th className="border px-2 py-1">å ±åˆ°æ™‚é–“</th>
              </tr>
            </thead>
            <tbody>
              {attendees.map((m: any) => (
                <tr key={m.id}>
                  <td className="border px-2 py-1">{m.name}</td>
                  <td className="border px-2 py-1">{m.phone}</td>
                  <td className="border px-2 py-1">
                    {new Date(m.checkedInAt).toLocaleString()}
                  </td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>

        <div>
          <h3 className="text-lg font-semibold mb-2">âŒ æœªå ±åˆ°åå–®</h3>
          <table className="w-full border-collapse text-sm">
            <thead>
              <tr className="bg-gray-100">
                <th className="border px-2 py-1">å§“å</th>
                <th className="border px-2 py-1">æ‰‹æ©Ÿ</th>
              </tr>
            </thead>
            <tbody>
              {notCheckedIn.map((m: any) => (
                <tr key={m.id}>
                  <td className="border px-2 py-1">{m.name}</td>
                  <td className="border px-2 py-1">{m.phone}</td>
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  );
};

export default CheckinStatsPage;
âœ… 3ï¸âƒ£ å°æé†’ï¼šæ¬Šé™é©—è­‰ï¼ˆRBACï¼‰
ä½ å¯æ­é… getServerSideProps åŠ ä¸Šè§’è‰²é©—è­‰ï¼ˆå‰è¿°å·²èªªæ˜ï¼‰ï¼Œä¹Ÿå¯æ•´åˆä½ æ—¢æœ‰çš„ session.user.role æˆ– JWT è§£ç¢¼é©—è­‰