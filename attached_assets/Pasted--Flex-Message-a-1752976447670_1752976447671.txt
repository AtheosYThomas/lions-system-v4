æˆ‘å€‘æ¥ä¸‹ä¾†å°‡å®Œæˆ âœ…ã€Œæ¨£æ¿å¥—ç”¨è‡³æ´»å‹•æ¨æ’­æµç¨‹ã€ï¼Œè®“æœƒé•·ï¼å¹¹éƒ¨åœ¨æ¯å ´æ´»å‹•ä¸­å¿«é€Ÿé¸æ“‡ä¸¦å¥—ç”¨ Flex Message æ¨£æ¿ç”¨æ–¼å ±åˆ°é€šçŸ¥æ¨æ’­ã€‚

âœ… åŠŸèƒ½ç›®æ¨™
æ¨¡çµ„	åŠŸèƒ½
ğŸ§© é¸æ“‡æ¨£æ¿	åœ¨æ´»å‹•ç®¡ç†é  /admin/events â†’ é»æ“Šã€Œæ¨æ’­é€šçŸ¥ã€æ™‚å½ˆå‡ºæ¨£æ¿é¸å–®
ğŸ“„ å¥—ç”¨æ¨£æ¿	é¸æ“‡å¾Œå°‡å°æ‡‰ JSON å¥—ç”¨ç‚ºæ¨æ’­å…§å®¹
ğŸ“¤ ç™¼é€æ¨æ’­	ä½¿ç”¨ LINE Bot ç™¼é€ Flex Message çµ¦å ±åæœƒå“¡

âœ… Step 1ï¼šæ¨£æ¿æŸ¥è©¢ APIï¼ˆé™å®šé¡å‹ç‚º checkin_reminderï¼‰
å»ºç«‹ /api/admin/push-template/by-type.tsï¼š

ts
è¤‡è£½
ç·¨è¼¯
import { prisma } from "@/lib/prisma";
import { NextApiRequest, NextApiResponse } from "next";

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  const { type } = req.query;
  if (!type) return res.status(400).json({ error: "ç¼ºå°‘ type åƒæ•¸" });

  const templates = await prisma.pushTemplate.findMany({
    where: { type: type as string },
    orderBy: { createdAt: "desc" },
  });

  res.status(200).json({ templates });
}
âœ… Step 2ï¼šæ´»å‹•ç®¡ç†é  Push æŒ‰éˆ•å½ˆå‡ºã€Œæ¨£æ¿é¸å–®ã€Modal
UI ç¯„ä¾‹ï¼ˆç°¡åŒ–ï¼‰
tsx
è¤‡è£½
ç·¨è¼¯
const [showPushModal, setShowPushModal] = useState(false);
const [templateOptions, setTemplateOptions] = useState([]);
const [selectedTemplateId, setSelectedTemplateId] = useState("");

useEffect(() => {
  if (showPushModal) {
    fetch("/api/admin/push-template/by-type?type=checkin_reminder")
      .then(res => res.json())
      .then(data => setTemplateOptions(data.templates));
  }
}, [showPushModal]);
Modal å…§å®¹
tsx
è¤‡è£½
ç·¨è¼¯
{showPushModal && (
  <div className="fixed inset-0 bg-black bg-opacity-30 flex justify-center items-center">
    <div className="bg-white p-6 rounded shadow w-[500px]">
      <h2 className="text-lg font-bold mb-3">ğŸ“£ æ¨æ’­æ¨£æ¿é¸æ“‡</h2>
      <select
        className="border px-2 py-1 rounded w-full mb-4"
        value={selectedTemplateId}
        onChange={(e) => setSelectedTemplateId(e.target.value)}
      >
        <option value="">è«‹é¸æ“‡æ¨£æ¿</option>
        {templateOptions.map((tpl) => (
          <option key={tpl.id} value={tpl.id}>
            {tpl.name}
          </option>
        ))}
      </select>
      <div className="text-right">
        <button onClick={() => setShowPushModal(false)} className="mr-2 px-3 py-1 rounded border">å–æ¶ˆ</button>
        <button
          className="bg-blue-600 text-white px-4 py-1 rounded"
          onClick={async () => {
            const tpl = templateOptions.find(t => t.id === selectedTemplateId);
            if (!tpl) return;

            const res = await fetch(`/api/admin/push/checkin`, {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({
                eventId,
                templateJson: tpl.json,
              }),
            });

            if (res.ok) {
              alert("âœ… æ¨æ’­æˆåŠŸ");
              setShowPushModal(false);
            } else {
              alert("âŒ æ¨æ’­å¤±æ•—");
            }
          }}
        >
          ç™¼é€æ¨æ’­
        </button>
      </div>
    </div>
  </div>
)}
âœ… Step 3ï¼šå»ºç«‹æ¨æ’­ API /api/admin/push/checkin.ts
ts
è¤‡è£½
ç·¨è¼¯
import { client } from "@/lib/lineClient";
import { prisma } from "@/lib/prisma";
import { NextApiRequest, NextApiResponse } from "next";

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  const { eventId, templateJson } = req.body;

  if (!eventId || !templateJson) {
    return res.status(400).json({ error: "ç¼ºå°‘åƒæ•¸" });
  }

  const signups = await prisma.signup.findMany({
    where: { eventId },
    select: {
      member: { select: { lineUserId: true } }
    }
  });

  const results = await Promise.allSettled(
    signups
      .filter(s => !!s.member?.lineUserId)
      .map(s => client.pushMessage(s.member.lineUserId!, {
        type: "flex",
        altText: "ğŸ“£ æ´»å‹•å ±åˆ°é€šçŸ¥",
        contents: templateJson,
      }))
  );

  res.status(200).json({ success: true, results });
}
âœ… å®Œæ•´æˆæœ
æ¨¡çµ„	ç‹€æ…‹
ğŸ“‹ æ¨£æ¿æŸ¥è©¢ API	âœ… /api/admin/push-template/by-type
ğŸ› æ¨æ’­ UI é¸å–®	âœ… æ´»å‹•ç®¡ç†é æŒ‰éˆ•å½ˆå‡ºæ¨£æ¿é¸æ“‡
ğŸ“¤ ç™¼é€ API æ•´åˆ	âœ… å¥—ç”¨æ¨£æ¿å¾Œå³æ¨æ’­æ‰€æœ‰å ±åæœƒå“¡

