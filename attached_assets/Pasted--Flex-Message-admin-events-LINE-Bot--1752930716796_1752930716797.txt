å¤ªå¥½äº†ï¼Œæˆ‘å€‘ä¾†å¯¦ä½œ ğŸ“£ Flex Message å ±åˆ°é€šçŸ¥æ¨æ’­åŠŸèƒ½ï¼Œè®“ç®¡ç†è€…å¯ç›´æ¥åœ¨ /admin/events é»æ“Šã€Œæ¨æ’­é€šçŸ¥ã€ï¼Œé€é LINE Bot ç™¼é€æ´»å‹•å ±åˆ°æé†’ï¼ˆå«æ´»å‹•è³‡è¨Šèˆ‡å ±åˆ°é€£çµï¼‰ã€‚

âœ… åŠŸèƒ½ç¸½è¦½
åŠŸèƒ½	èªªæ˜
ğŸ”˜ ã€Œæ¨æ’­é€šçŸ¥ã€æŒ‰éˆ•	æ¯ç­†æ´»å‹•åˆ—å‡ºä¸€å€‹æ¨æ’­æŒ‰éˆ•
ğŸ“¬ å‘¼å«å¾Œç«¯ API /api/admin/event/:id/notify	
ğŸ¤– å¾Œç«¯ä½¿ç”¨ LINE Bot Push API æ¨é€ Flex Message	
ğŸ”— Flex Message å…§å®¹å«ï¼šæ´»å‹•åç¨±ã€æ—¥æœŸã€å ±åˆ°é€£çµï¼ˆ/checkin/:eventIdï¼‰	
ğŸ”’ åƒ…æœƒé•·ï¼å¹¹éƒ¨æœ‰æ¬Šæ“ä½œï¼ˆå¯åŠ  RBAC é©—è­‰ï¼‰	

âœ… 1ï¸âƒ£ Flex Message æ¨£æ¿ï¼ˆæ´»å‹•é€šçŸ¥ï¼‰
ts
è¤‡è£½
ç·¨è¼¯
export const createCheckinFlexMessage = (title: string, date: string, eventId: string) => ({
  type: 'flex',
  altText: `ğŸ“¢ å ±åˆ°é€šçŸ¥ï½œ${title}`,
  contents: {
    type: 'bubble',
    size: 'mega',
    hero: {
      type: 'image',
      url: 'https://example.com/banner.jpg', // å¯è‡ªè¨‚å ±åˆ°ç”¨åœ–
      size: 'full',
      aspectRatio: '16:9',
      aspectMode: 'cover',
    },
    body: {
      type: 'box',
      layout: 'vertical',
      spacing: 'md',
      contents: [
        {
          type: 'text',
          text: `ğŸ“¢ ${title}`,
          weight: 'bold',
          size: 'xl',
          wrap: true,
        },
        {
          type: 'text',
          text: `ğŸ“… æ—¥æœŸï¼š${date}`,
          size: 'sm',
          color: '#555555',
        },
        {
          type: 'text',
          text: `ğŸ“ è«‹é»é¸ä¸‹æ–¹å ±åˆ°`,
          size: 'sm',
          color: '#777777',
        },
      ],
    },
    footer: {
      type: 'box',
      layout: 'vertical',
      contents: [
        {
          type: 'button',
          style: 'primary',
          action: {
            type: 'uri',
            label: 'ç«‹å³å ±åˆ°',
            uri: `https://service.peida.net/checkin/${eventId}`,
          },
        },
      ],
    },
  },
});
âœ… 2ï¸âƒ£ å»ºç«‹å¾Œç«¯ API /pages/api/admin/event/[id]/notify.ts
ts
è¤‡è£½
ç·¨è¼¯
import { prisma } from '@/lib/prisma';
import { createCheckinFlexMessage } from '@/lib/line/flexTemplates';
import { lineClient } from '@/lib/line/client'; // LINE SDK åˆå§‹åŒ–
import { NextApiRequest, NextApiResponse } from 'next';

export default async function handler(req: NextApiRequest, res: NextApiResponse) {
  const { id: eventId } = req.query;
  if (!eventId || Array.isArray(eventId)) return res.status(400).json({ error: 'ç¼ºå°‘æ´»å‹• ID' });

  try {
    const event = await prisma.event.findUnique({ where: { id: eventId } });
    if (!event) return res.status(404).json({ error: 'æ‰¾ä¸åˆ°æ´»å‹•' });

    const message = createCheckinFlexMessage(event.title, event.date.toISOString().slice(0, 10), event.id);

    // æ¨æ’­å°è±¡ï¼šæ‰€æœ‰æœƒå“¡ï¼ˆæˆ–ç‰¹å®š group/userIdï¼‰
    const members = await prisma.member.findMany({ where: { line_user_id: { not: null } } });

    const pushList = members
      .filter((m) => m.line_user_id)
      .map((m) => lineClient.pushMessage(m.line_user_id, message));

    await Promise.allSettled(pushList);

    res.status(200).json({ success: true });
  } catch (err) {
    console.error('æ¨æ’­éŒ¯èª¤:', err);
    res.status(500).json({ error: 'æ¨æ’­å¤±æ•—' });
  }
}
âœ… 3ï¸âƒ£ LINE Bot åˆå§‹åŒ– lib/line/client.ts
ts
è¤‡è£½
ç·¨è¼¯
import { Client } from '@line/bot-sdk';

export const lineClient = new Client({
  channelAccessToken: process.env.LINE_CHANNEL_ACCESS_TOKEN!,
  channelSecret: process.env.LINE_CHANNEL_SECRET!,
});
ğŸ“¦ è«‹è¨˜å¾—è¨­å®š .envï¼š

ini
è¤‡è£½
ç·¨è¼¯
LINE_CHANNEL_ACCESS_TOKEN=ä½ çš„é•·æ•ˆ token
LINE_CHANNEL_SECRET=ä½ çš„ secret
âœ… 4ï¸âƒ£ å‰ç«¯ /admin/events åŠ å…¥ã€ŒğŸ“£ æ¨æ’­é€šçŸ¥ã€æŒ‰éˆ•
tsx
è¤‡è£½
ç·¨è¼¯
<button
  className="text-sm text-green-600"
  onClick={async () => {
    if (!confirm(`ç¢ºå®šè¦æ¨æ’­ã€Œ${e.title}ã€å ±åˆ°é€šçŸ¥ï¼Ÿ`)) return;

    const res = await fetch(`/api/admin/event/${e.id}/notify`, { method: 'POST' });
    if (res.ok) {
      alert('æ¨æ’­å®Œæˆ');
    } else {
      alert('æ¨æ’­å¤±æ•—');
    }
  }}
>
  ğŸ“£ æ¨æ’­
</button>
âœ… æˆæœç¤ºæ„
Flex Message å°‡æœƒç™¼é€è‡³æœƒå“¡ LINEï¼ŒåŒ…æ‹¬ï¼š

æ´»å‹•æ¨™é¡Œ

æ—¥æœŸ

å ±åˆ°æŒ‰éˆ•ï¼ˆå°å‘ /checkin/:eventIdï¼‰

