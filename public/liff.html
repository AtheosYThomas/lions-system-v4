<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <title>åŒ—å¤§ç…å­æœƒæœƒå“¡è¨»å†Š</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }
      .container {
        max-width: 400px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }
      .header {
        text-align: center;
        margin-bottom: 30px;
      }
      .logo {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }
      .title {
        font-size: 1.5rem;
        font-weight: bold;
        color: #333;
        margin-bottom: 10px;
      }
      .subtitle {
        color: #666;
        font-size: 0.9rem;
      }
      .status {
        padding: 15px;
        border-radius: 10px;
        margin: 20px 0;
        text-align: center;
      }
      .loading {
        background: #e3f2fd;
        color: #1976d2;
        border: 1px solid #bbdefb;
      }
      .success {
        background: #e8f5e8;
        color: #2e7d32;
        border: 1px solid #c8e6c9;
      }
      .error {
        background: #ffebee;
        color: #c62828;
        border: 1px solid #ffcdd2;
      }
      .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #1976d2;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 10px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="logo">ğŸ¦</div>
        <div class="title">åŒ—å¤§ç…å­æœƒ</div>
        <div class="subtitle">æœƒå“¡è¨»å†Šç³»çµ±</div>
      </div>

      <div id="status" class="status loading">
        <div class="spinner"></div>
        æ­£åœ¨åˆå§‹åŒ– LINE ç™»å…¥...
      </div>
    </div>

    <script>
      const statusDiv = document.getElementById('status');

      function updateStatus(message, type = 'loading') {
        statusDiv.className = `status ${type}`;
        statusDiv.innerHTML =
          type === 'loading'
            ? `<div class="spinner"></div>${message}`
            : message;
      }

      async function main() {
        try {
          // å–å¾— LIFF é…ç½®
          updateStatus('æ­£åœ¨è¼‰å…¥ LIFF é…ç½®...');
          const configResponse = await fetch('/api/liff/config');
          const config = await configResponse.json();

          if (!config.success) {
            throw new Error('ç„¡æ³•è¼‰å…¥ LIFF é…ç½®');
          }

          if (config.isDefault) {
            updateStatus('âš ï¸ ä½¿ç”¨é è¨­ LIFF IDï¼ŒåŠŸèƒ½å¯èƒ½ç„¡æ³•æ­£å¸¸é‹ä½œ', 'error');
            setTimeout(() => {
              updateStatus('è«‹è¯ç¹«ç®¡ç†å“¡è¨­å®šæ­£ç¢ºçš„ LIFF App ID', 'error');
            }, 3000);
            return;
          }

          // åˆå§‹åŒ– LIFF
          updateStatus('æ­£åœ¨åˆå§‹åŒ– LINE ç™»å…¥...');
          console.log('ğŸ“± ä½¿ç”¨ LIFF ID:', config.liffId);
          await liff.init({
            liffId: config.liffId,
          });

          // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
          if (!liff.isLoggedIn()) {
            updateStatus('è«‹ç™»å…¥ LINE å¸³è™Ÿ...');
            liff.login();
            return;
          }

          // ç²å–ç”¨æˆ¶è³‡æ–™
          updateStatus('æ­£åœ¨å–å¾—ç”¨æˆ¶è³‡æ–™...');
          const profile = await liff.getProfile();

          console.log('ğŸ“± ç”¨æˆ¶è³‡æ–™:', {
            userId: profile.userId,
            displayName: profile.displayName,
            pictureUrl: profile.pictureUrl,
          });

          // æª¢æŸ¥æœƒå“¡ç‹€æ…‹
          updateStatus('æ­£åœ¨æª¢æŸ¥æœƒå“¡ç‹€æ…‹...');
          const response = await fetch('/api/liff/check-member', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              line_user_id: profile.userId,
              display_name: profile.displayName,
              picture_url: profile.pictureUrl,
            }),
          });

          if (!response.ok) {
            throw new Error(`ä¼ºæœå™¨éŒ¯èª¤: ${response.status}`);
          }

          const result = await response.json();

          if (result.success) {
            if (result.is_member) {
              updateStatus(`âœ… æ­¡è¿å›ä¾†ï¼Œ${result.member_name}ï¼`, 'success');
            } else {
              updateStatus('ğŸš€ å°å‘è‡³è¨»å†Šé é¢...');
              // å°å‘åˆ°è¨»å†Šé é¢ï¼Œä¸¦å¸¶å…¥ LINE ç”¨æˆ¶è³‡æ–™
              window.location.href = `/register?line_user_id=${encodeURIComponent(profile.userId)}&display_name=${encodeURIComponent(profile.displayName)}&picture_url=${encodeURIComponent(profile.pictureUrl || '')}`;
              return;
            }
          } else {
            updateStatus(`âŒ æª¢æŸ¥å¤±æ•—ï¼š${result.error || 'æœªçŸ¥éŒ¯èª¤'}`, 'error');
          }

          // 3ç§’å¾Œé—œé–‰è¦–çª—
          setTimeout(() => {
            if (liff.isInClient()) {
              liff.closeWindow();
            }
          }, 3000);
        } catch (error) {
          console.error('LIFF åˆå§‹åŒ–éŒ¯èª¤:', error);

          let errorMessage = '';
          let suggestion = '';

          if (error.code === 404) {
            errorMessage = 'LIFF App ID ä¸å­˜åœ¨æˆ–æœªæ­£ç¢ºé…ç½®';
            suggestion = 'è«‹ç¢ºèª LIFF App ID æ˜¯å¦æ­£ç¢ºï¼Œæˆ–è¯ç¹«ç³»çµ±ç®¡ç†å“¡';
          } else if (error.code === 403) {
            errorMessage = 'LIFF æ‡‰ç”¨ç¨‹å¼æœªå•Ÿç”¨æˆ–æ¬Šé™ä¸è¶³';
            suggestion = 'è«‹æª¢æŸ¥ LIFF æ‡‰ç”¨ç¨‹å¼è¨­å®š';
          } else if (error.code === 400) {
            errorMessage = 'LIFF åˆå§‹åŒ–åƒæ•¸éŒ¯èª¤';
            suggestion = 'è«‹æª¢æŸ¥ LIFF App ID æ ¼å¼';
          } else {
            errorMessage = error.message || 'æœªçŸ¥çš„ LIFF éŒ¯èª¤';
            suggestion = 'è«‹ç¨å¾Œå†è©¦æˆ–è¯ç¹«æŠ€è¡“æ”¯æ´';
          }

          updateStatus(`âŒ ${errorMessage}`, 'error');

          // æ·»åŠ é‡è©¦æŒ‰éˆ•
          const retryBtn = document.createElement('button');
          retryBtn.textContent = 'ğŸ”„ é‡æ–°å˜—è©¦';
          retryBtn.style.cssText = `
          margin-top: 15px;
          padding: 10px 20px;
          background: #1976d2;
          color: white;
          border: none;
          border-radius: 5px;
          cursor: pointer;
        `;
          retryBtn.onclick = () => window.location.reload();
          statusDiv.appendChild(retryBtn);

          // æ·»åŠ å»ºè­°æ–‡å­—
          const suggestionDiv = document.createElement('div');
          suggestionDiv.style.cssText =
            'margin-top: 10px; font-size: 0.9rem; color: #666;';
          suggestionDiv.textContent = suggestion;
          statusDiv.appendChild(suggestionDiv);
        }
      }

      main();
    </script>
  </body>
</html>
