<!doctype html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <title>åŒ—å¤§ç…å­æœƒ - æœƒå“¡è¨»å†Š</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
      body {
        font-family:
          -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        margin: 0;
        padding: 20px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
      }
      .container {
        max-width: 500px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 15px;
        box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
      }
      .header {
        text-align: center;
        margin-bottom: 30px;
      }
      .logo {
        font-size: 2.5rem;
        margin-bottom: 10px;
      }
      .title {
        font-size: 1.5rem;
        font-weight: bold;
        color: #333;
        margin-bottom: 10px;
      }
      .subtitle {
        color: #666;
        font-size: 0.9rem;
      }
      .form-group {
        margin-bottom: 20px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
        color: #333;
      }
      .required {
        color: #dc3545;
      }
      input {
        width: 100%;
        padding: 12px;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        box-sizing: border-box;
        font-size: 16px;
        transition: border-color 0.3s;
      }
      input:focus {
        outline: none;
        border-color: #667eea;
      }
      input:required:invalid {
        border-color: #dc3545;
      }
      button {
        width: 100%;
        padding: 15px;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        cursor: pointer;
        transition: transform 0.2s;
      }
      button:hover {
        transform: translateY(-2px);
      }
      button:disabled {
        opacity: 0.6;
        cursor: not-allowed;
        transform: none;
      }
      .status {
        padding: 15px;
        border-radius: 10px;
        margin: 20px 0;
        text-align: center;
      }
      .loading {
        background: #e3f2fd;
        color: #1976d2;
        border: 1px solid #bbdefb;
      }
      .success {
        background: #e8f5e8;
        color: #2e7d32;
        border: 1px solid #c8e6c9;
      }
      .error {
        background: #ffebee;
        color: #c62828;
        border: 1px solid #ffcdd2;
      }
      .spinner {
        display: inline-block;
        width: 20px;
        height: 20px;
        border: 3px solid #f3f3f3;
        border-top: 3px solid #1976d2;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin-right: 10px;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      .form-row {
        display: flex;
        gap: 15px;
      }
      .form-row .form-group {
        flex: 1;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <div class="logo">ğŸ¦</div>
        <div class="title">åŒ—å¤§ç…å­æœƒ</div>
        <div class="subtitle">æœƒå“¡è¨»å†Šç³»çµ±</div>
      </div>

      <div id="status" class="status loading">
        <div class="spinner"></div>
        æ­£åœ¨åˆå§‹åŒ– LINE ç™»å…¥...
      </div>

      <form id="registerForm" style="display: none">
        <input type="hidden" id="line_user_id" name="line_user_id" required />

        <div class="form-group">
          <label for="name">ä¸­æ–‡å§“å <span class="required">*</span></label>
          <input
            type="text"
            id="name"
            name="name"
            required
            placeholder="è«‹è¼¸å…¥æ‚¨çš„ä¸­æ–‡å§“å"
          />
        </div>

        <div class="form-group">
          <label for="english_name">è‹±æ–‡å§“å</label>
          <input
            type="text"
            id="english_name"
            name="english_name"
            placeholder="è«‹è¼¸å…¥æ‚¨çš„è‹±æ–‡å§“å"
          />
        </div>

        <div class="form-group">
          <label for="birthday">ç”Ÿæ—¥ <span class="required">*</span></label>
          <input type="date" id="birthday" name="birthday" required />
        </div>

        <div class="form-group">
          <label for="job_title">è·æ¥­ <span class="required">*</span></label>
          <input
            type="text"
            id="job_title"
            name="job_title"
            required
            placeholder="è«‹è¼¸å…¥æ‚¨çš„è·æ¥­"
          />
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="mobile">æ‰‹æ©Ÿè™Ÿç¢¼ <span class="required">*</span></label>
            <input
              type="tel"
              id="mobile"
              name="mobile"
              required
              placeholder="0912-345-678"
            />
          </div>
          <div class="form-group">
            <label for="phone">å¸‚è©±</label>
            <input
              type="tel"
              id="phone"
              name="phone"
              placeholder="02-2345-6789"
            />
          </div>
        </div>

        <div class="form-group">
          <label for="fax">å‚³çœŸ</label>
          <input type="tel" id="fax" name="fax" placeholder="02-2345-6789" />
        </div>

        <div class="form-group">
          <label for="address">åœ°å€ <span class="required">*</span></label>
          <input
            type="text"
            id="address"
            name="address"
            required
            placeholder="è«‹è¼¸å…¥æ‚¨çš„å®Œæ•´åœ°å€"
          />
        </div>

        <div class="form-group">
          <label for="email">Email <span class="required">*</span></label>
          <input
            type="email"
            id="email"
            name="email"
            required
            placeholder="example@email.com"
          />
        </div>

        <button type="submit" id="submitBtn">ğŸ¯ å®Œæˆè¨»å†Š</button>
      </form>
    </div>

    <script>
      const statusDiv = document.getElementById('status');
      const form = document.getElementById('registerForm');
      const submitBtn = document.getElementById('submitBtn');
      let currentProfile = null;

      function updateStatus(message, type = 'loading') {
        statusDiv.className = `status ${type}`;
        statusDiv.innerHTML =
          type === 'loading'
            ? `<div class="spinner"></div>${message}`
            : message;
      }

      async function main() {
        try {
          // æª¢æŸ¥æ˜¯å¦åœ¨ LINE ç’°å¢ƒä¸­
          if (!window.liff) {
            updateStatus('âŒ æ­¤é é¢éœ€è¦åœ¨ LINE æ‡‰ç”¨ç¨‹å¼ä¸­é–‹å•Ÿ', 'error');
            return;
          }

          // å–å¾— LIFF é…ç½®
          updateStatus('æ­£åœ¨è¼‰å…¥ LIFF é…ç½®...');
          const configResponse = await fetch('/api/liff/config');
          const config = await configResponse.json();

          if (!config.success) {
            throw new Error('ç„¡æ³•è¼‰å…¥ LIFF é…ç½®');
          }

          // å³ä½¿æ˜¯é è¨­ LIFF ID ä¹Ÿå˜—è©¦åˆå§‹åŒ–
          if (config.isDefault) {
            console.log('âš ï¸ ä½¿ç”¨é è¨­ LIFF ID');
          }

          // åˆå§‹åŒ– LIFF
          updateStatus('æ­£åœ¨åˆå§‹åŒ– LINE ç™»å…¥...');
          await liff.init({
            liffId: config.liffId,
          });

          console.log('âœ… LIFF åˆå§‹åŒ–æˆåŠŸ');
          console.log('ğŸ“± LIFF ç’°å¢ƒ:', {
            isLoggedIn: liff.isLoggedIn(),
            isInClient: liff.isInClient(),
            os: liff.getOS(),
            language: liff.getLanguage(),
            version: liff.getVersion(),
          });

          // æª¢æŸ¥ç™»å…¥ç‹€æ…‹
          if (!liff.isLoggedIn()) {
            updateStatus('è«‹ç™»å…¥ LINE å¸³è™Ÿ...');
            liff.login();
            return;
          }

          // ç²å–ç”¨æˆ¶è³‡æ–™
          updateStatus('æ­£åœ¨å–å¾—ç”¨æˆ¶è³‡æ–™...');
          currentProfile = await liff.getProfile();

          console.log('ğŸ“± ç”¨æˆ¶è³‡æ–™:', {
            userId: currentProfile.userId,
            displayName: currentProfile.displayName,
            pictureUrl: currentProfile.pictureUrl,
          });

          // è¨­å®šéš±è—æ¬„ä½
          document.getElementById('line_user_id').value = currentProfile.userId;

          // æª¢æŸ¥æ˜¯å¦å·²ç¶“æ˜¯æœƒå“¡
          updateStatus('æ­£åœ¨æª¢æŸ¥æœƒå“¡ç‹€æ…‹...');
          const checkRes = await fetch('/api/liff/check-member', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              line_user_id: currentProfile.userId,
              display_name: currentProfile.displayName,
              picture_url: currentProfile.pictureUrl,
            }),
          });

          if (!checkRes.ok) {
            throw new Error(`ä¼ºæœå™¨éŒ¯èª¤: ${checkRes.status}`);
          }

          const checkResult = await checkRes.json();

          if (checkResult.success) {
            if (checkResult.is_member) {
              updateStatus(`âœ… ${checkResult.message}`, 'success');
              setTimeout(() => {
                if (liff.isInClient()) {
                  liff.closeWindow();
                }
              }, 3000);
            } else {
              statusDiv.style.display = 'none';
              form.style.display = 'block';

              // é å¡«é¡¯ç¤ºåç¨±
              document.getElementById('name').value =
                currentProfile.displayName || '';
            }
          } else {
            updateStatus(
              `âŒ æª¢æŸ¥å¤±æ•—ï¼š${checkResult.error || 'æœªçŸ¥éŒ¯èª¤'}`,
              'error'
            );
          }
        } catch (error) {
          console.error('âŒ LIFF éŒ¯èª¤:', error);
          updateStatus(`âŒ åˆå§‹åŒ–å¤±æ•—ï¼š${error.message}`, 'error');
        }
      }

      // è¡¨å–®æäº¤è™•ç†
      form.addEventListener('submit', async e => {
        e.preventDefault();

        if (!currentProfile) {
          updateStatus('âŒ ç”¨æˆ¶è³‡æ–™æœªå–å¾—', 'error');
          return;
        }

        submitBtn.disabled = true;
        submitBtn.innerHTML = '<div class="spinner"></div>è¨»å†Šä¸­...';

        const formData = new FormData(e.target);
        const registerData = Object.fromEntries(formData.entries());

        // ç§»é™¤ç©ºå€¼
        Object.keys(registerData).forEach(key => {
          if (registerData[key] === '') {
            delete registerData[key];
          }
        });

        console.log('ğŸ“ è¨»å†Šè³‡æ–™:', registerData);

        try {
          const res = await fetch('/api/liff/register', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(registerData),
          });

          const result = await res.json();

          if (result.success) {
            form.style.display = 'none';
            statusDiv.style.display = 'block';
            updateStatus(`ğŸ‰ ${result.message}`, 'success');

            setTimeout(() => {
              if (liff.isInClient()) {
                liff.closeWindow();
              }
            }, 3000);
          } else {
            updateStatus(`âŒ ${result.error}`, 'error');
            statusDiv.style.display = 'block';
          }
        } catch (err) {
          console.error('è¨»å†ŠéŒ¯èª¤:', err);
          updateStatus('âŒ è¨»å†Šå¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦', 'error');
          statusDiv.style.display = 'block';
        } finally {
          submitBtn.disabled = false;
          submitBtn.innerHTML = 'ğŸ¯ å®Œæˆè¨»å†Š';
        }
      });

      main();
    </script>
  </body>
</html>